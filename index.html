<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Photo Logger</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 1em;
      padding-bottom: 60px;
    }
    input, textarea, button {
      width: 100%;
      margin-bottom: 10px;
      font-size: 1em;
      padding: 0.6em;
      box-sizing: border-box;
    }
    img {
      max-width: 100%;
      height: auto;
      margin-bottom: 0.5em;
    }
    .entry {
      border: 1px solid #ccc;
      padding: 0.8em;
      margin-bottom: 1em;
    }
    #clearButton {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: red;
      color: white;
      border: none;
      padding: 1em;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <input type="file" accept="image/*" capture="environment" id="photoInput" />
  <input type="text" id="locationInput" placeholder="Enter location" />
  <textarea id="descriptionInput" placeholder="Enter description"></textarea>
  <button onclick="addEntry()">Add Entry</button>
  <button onclick="exportPDF()">Export as PDF</button>
  <div id="entries"></div>
  <button id="clearButton" onclick="clearEntries()">Clear All Entries</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <script>
    const photoInput = document.getElementById('photoInput');
    const locationInput = document.getElementById('locationInput');
    const descriptionInput = document.getElementById('descriptionInput');
    const entriesDiv = document.getElementById('entries');

    let entries = JSON.parse(localStorage.getItem('photoLogEntries') || '[]');
    entries.forEach(renderEntry);

    function saveEntries() {
      localStorage.setItem('photoLogEntries', JSON.stringify(entries));
    }

    function clearEntries() {
      if (confirm('Are you sure you want to clear all entries?')) {
        entries = [];
        saveEntries();
        entriesDiv.innerHTML = '';
      }
    }

    function renderEntry(entry) {
      const div = document.createElement('div');
      div.className = 'entry';
      const img = document.createElement('img');
      img.src = entry.image;
      const loc = document.createElement('p');
      loc.textContent = 'üìç ' + entry.location;
      const desc = document.createElement('p');
      desc.textContent = entry.description;
      div.appendChild(img);
      div.appendChild(loc);
      div.appendChild(desc);
      entriesDiv.appendChild(div);
    }

    function fixOrientation(file, callback) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          EXIF.getData(img, function() {
            const orientation = EXIF.getTag(this, 'Orientation') || 1;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            let width = img.width;
            let height = img.height;

            if ([5,6,7,8].includes(orientation)) {
              canvas.width = height;
              canvas.height = width;
            } else {
              canvas.width = width;
              canvas.height = height;
            }

            switch (orientation) {
              case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
              case 3: ctx.transform(-1, 0, 0, -1, width, height); break;
              case 4: ctx.transform(1, 0, 0, -1, 0, height); break;
              case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
              case 6: ctx.transform(0, 1, -1, 0, height, 0); break;
              case 7: ctx.transform(0, -1, -1, 0, height, width); break;
              case 8: ctx.transform(0, -1, 1, 0, 0, width); break;
              default: break;
            }

            ctx.drawImage(img, 0, 0);
            callback(canvas.toDataURL('image/jpeg'));
          });
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    function addEntry() {
      const file = photoInput.files[0];
      if (!file) return alert('Please select a photo.');
      fixOrientation(file, function(fixedImage) {
        const location = locationInput.value.trim();
        const description = descriptionInput.value.trim();
        const entry = { image: fixedImage, location, description };
        entries.push(entry);
        saveEntries();
        renderEntry(entry);
        locationInput.value = '';
        descriptionInput.value = '';
        photoInput.value = '';
      });
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      let count = 0;

      for (let i = 0; i < entries.length; i++) {
        const entry = entries[i];
        const img = new Image();
        img.src = entry.image;
        await new Promise(resolve => img.onload = resolve);
        const width = doc.internal.pageSize.getWidth();
        const imgHeight = (width * img.height) / img.width * 0.5; // smaller images

        doc.addImage(entry.image, 'JPEG', 10, y, width - 20, imgHeight);
        y += imgHeight + 5;

        doc.setFontSize(10);
        doc.text('üìç ' + entry.location, 10, y);
        y += 6;
        doc.text(entry.description, 10, y);
        y += 15;

        count++;
        if (count % 3 === 0 && i < entries.length - 1) {
          doc.addPage();
          y = 10;
        }
      }

      doc.save('photo_log.pdf');
    }
  </script>
</body>
</html>
