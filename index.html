<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo Logger</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    .entry { margin-bottom: 1.5em; border-bottom: 1px solid #ccc; padding-bottom: 1em; }
    /* Restrict max width but keep natural height to preserve aspect ratio */
    img {
      max-width: 100px;
      height: auto;
      display: block;
      margin-top: 0.5em;
    }
  </style>
</head>
<body>
  <h1>Photo Logger</h1>
  <form id="photoForm">
    <label>Photo: <input type="file" id="photo" accept="image/*" required></label><br><br>
    <label>Location: <input type="text" id="location" required></label><br><br>
    <label>Description: <textarea id="description" required></textarea></label><br><br>
    <button type="submit">Add Entry</button>
  </form>
  <hr>
  <div id="entries"></div>
  <br>
  <button onclick="exportAsPDF()">Export as PDF</button>

  <script>
    const entries = [];

    function getOrientation(file, callback) {
      EXIF.getData(file, function () {
        const orientation = EXIF.getTag(this, 'Orientation');
        callback(orientation);
      });
    }

    function fixImageOrientation(img, orientation, callback) {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      let width = img.width;
      let height = img.height;

      if ([5, 6, 7, 8].includes(orientation)) {
        canvas.width = height;
        canvas.height = width;
      } else {
        canvas.width = width;
        canvas.height = height;
      }

      switch (orientation) {
        case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
        case 3: ctx.transform(-1, 0, 0, -1, width, height); break;
        case 4: ctx.transform(1, 0, 0, -1, 0, height); break;
        case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
        case 6: ctx.transform(0, 1, -1, 0, height, 0); break;
        case 7: ctx.transform(0, -1, -1, 0, height, width); break;
        case 8: ctx.transform(0, -1, 1, 0, 0, width); break;
        default: ctx.setTransform(1, 0, 0, 1, 0, 0);
      }

      // Draw without specifying width/height to keep natural size
      if ([5, 6, 7, 8].includes(orientation)) {
        ctx.drawImage(img, 0, 0);
      } else {
        ctx.drawImage(img, 0, 0);
      }

      callback(canvas.toDataURL("image/jpeg"));
    }

    document.getElementById("photoForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const fileInput = document.getElementById("photo");
      const location = document.getElementById("location").value;
      const description = document.getElementById("description").value;

      const file = fileInput.files[0];
      if (!file) return;

      getOrientation(file, function (orientation) {
        const reader = new FileReader();
        reader.onload = function (event) {
          const img = new Image();
          img.onload = function () {
            fixImageOrientation(img, orientation || 1, function (fixedDataUrl) {
              entries.push({ image: fixedDataUrl, location, description });
              renderEntries();
              document.getElementById("photoForm").reset();
            });
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    });

    function renderEntries() {
      const container = document.getElementById("entries");
      container.innerHTML = "";
      entries.forEach(entry => {
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
          <strong>Location:</strong> ${entry.location}<br>
          <strong>Description:</strong> ${entry.description}<br>
          <img src="${entry.image}" />
        `;
        container.appendChild(div);
      });
    }

    async function exportAsPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 10;
      let y = margin;

      for (let i = 0; i < entries.length; i++) {
        const entry = entries[i];

        const img = new Image();
        img.src = entry.image;

        await new Promise((resolve) => {
          img.onload = () => {
            const aspectRatio = img.width / img.height;
            const maxWidth = pageWidth - margin * 2;
            const maxHeight = 100; // max height for all images

            let drawWidth = maxWidth;
            let drawHeight = drawWidth / aspectRatio;

            if (drawHeight > maxHeight) {
              drawHeight = maxHeight;
              drawWidth = drawHeight * aspectRatio;
            }

            if (y + drawHeight + 30 > pageHeight) {
              pdf.addPage();
              y = margin;
            }

            pdf.addImage(entry.image, 'JPEG', margin, y, drawWidth, drawHeight);
            y += drawHeight + 5;
            pdf.setFontSize(12);
            pdf.text(`Location: ${entry.location}`, margin, y);
            y += 6;
            pdf.text(`Description: ${entry.description}`, margin, y);
            y += 15;

            resolve();
          };
        });
      }

      pdf.save("photo_log.pdf");
    }
  </script>
</body>
</html>
